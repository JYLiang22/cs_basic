- [问题引入](#问题引入)
- [Keepalive作用](#keepalive作用)
- [主机崩溃](#主机崩溃)
- [进程崩溃](#进程崩溃)
- [有数据传输的场景下的一些异常情况](#有数据传输的场景下的一些异常情况)
  - [客户端主机宕机，又迅速重启](#客户端主机宕机又迅速重启)
  - [客户端主机宕机，一直没有重启](#客户端主机宕机一直没有重启)


# 问题引入
这是TCP异常断开连接的场景：一个tcp连接，在没有打开keepalive、没有数据交互的情况下，一端突然断电和一端的进程crash，有什么区别？


# Keepalive作用
以前讲过了


# 主机崩溃
客户端主机崩溃了，服务端是无法感知到的，在加上服务端没有开启 TCP keepalive，又没有数据交互的情况下，服务端的 TCP 连接将会一直处于 ESTABLISHED 连接状态，直到服务端重启进程。


# 进程崩溃
TCP 的连接信息是由内核维护的，所以当服务端的进程崩溃后，内核需要回收该进程的所有 TCP 连接资源，于是内核会发送第一次挥手 FIN 报文，后续的挥手过程也都是在内核完成，并不需要进程的参与，所以即使服务端的进程退出了，还是能与客户端完成 TCP四次挥手的过程。


# 有数据传输的场景下的一些异常情况


## 客户端主机宕机，又迅速重启
直接上结论：只要有一方重启完成后，收到之前 TCP 连接的报文，都会回复 RST 报文，以断开连接。分析过程看博客


## 客户端主机宕机，一直没有重启
超时重传 -> 断开连接
