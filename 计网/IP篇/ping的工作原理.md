ping是基于ICMP协议工作的，所以首先要了解ICMP协议的原理。<br>

ICMP协议的全称是互联网控制报文协议，提出此协议的原因是在复杂的互联网环境中传输信息时可能会出错，这个时候就要报错以调整传输策略。<br>

所以它的功能如下：

1. 确定IP包是否成功到达目标地址
2. 报告发送过程中IP包被废弃的原因和改善网络设置等

对应以上两个功能，ICMP有两种报文：

1. 查询报文类型
2. 差错报文类型

查询报文是用于判断发送的数据包是否已经成功到达对端的一种消息，可以分为两类，分别是回送请求消息和回送应答消息。<br>
其中回送请求消息是发送端主机向接收端主机发送的消息，类型为8；回送应答消息是接收端主机向发送端主机发回来的消息，类型为0。<br>

差错报文类型我了解的有三种，分别是目标不可达消息、重定向消息和超时消息。

1. 目标不可达具体原因可以详细分为以下几类：

   - 网络不可达：原因是路由器当中的路由表匹配不到接收方IP的网络号，就通过ICMP协议以网络不可达的原因告知主机，代码为0。
   - 主机不可达：路由器中的路由表中没有主机的消息或者主机没有连接到网络，会通过ICMP协议以主机不可达的原因告知主机，代码为1。
   - 协议不可达：当主机使用TCP协议访问对端主机，可以找到对端主机，但是对端主机的防火墙已经禁止TCP协议的访问，会通过ICMP协议以协议不可达的原因告知主机，代码为2。
   - 端口不可达：发送端主机可以找到对端主机，也没有防火墙限制，可以对端主机没有监听要访问的接口，会通过ICMP协议以端口不可达的原因告知主机，代码为3。
   - 需要分片但设置了不分片：发送端主机发送IP数据报时，数据报的大小超过了途中路由器允许的MTU大小，且IP首部的分片禁止标志位设置为1，这个时候路由器会直接抛弃该数据报，并通过ICMP协议以需要分片但设置了不分片的原因告知主机，代码为4。

2. 重定向消息

   - 在路由器持有更好的路由信息的情况下，它发现发送端主机使用了不是最优的路劲发送数据，就会返回一个ICMP重定向消息告知主机，这个消息中包含了最合适的路由信息。

3. 超时消息

   - 首先要知道 IP 包中有一个字段叫做 TTL （Time To Live，生存周期），它的值随着每经过一次路由器就会减 1，直到减到 0 时该 IP 包会被丢弃。此时，路由器将会发送一个 ICMP 超时消息给发送端主机，并通知该包已被丢弃。
   - 设置 IP 包生存周期的主要目的，是为了在路由控制遇到问题发生循环状况时，避免 IP 包无休止地在网络上被转发。


了解了以上ICMP协议的基础知识后，我们来进一步了解ping的工作原理。<br>
首先设定最简单的场景：同一个子网下的主机A和主机B，主机A执行ping主机B。<br>
接着可以参考小林coding图解理解，以下仅做关键字记录：<br>

主机A过程：

1. ICMP回送请求报文：类型、序号、发送时间
2. 加上IP头形成IP数据报：源地址、目标地址、协议
3. 加上MAC头形成数据帧：目标地址对应的目标MAC、本机MAC地址

主机B过程：

1. 收到A发过来的数据帧后，检查MAC地址是否匹配已确定是否接收，若接收则把IP数据包提取出来交给IP层
2. 接着按照同样的步骤，检查、提取ICMP回送请求报文给ICMP协议
3. ICMP协议根据ICMP回送请求报文生成一个ICMP回送响应报文：字段、序号、发送时间

在规定的时间，若主机A收到主机B发回来的ICMP回送响应报文，说明目标主机可达，否则不可达。
