# IP基础知识全家桶

理解框架：<br>

step 1：<br>
　　通过车票的例子区别了MAC和IP<br>

step 2：<br>
　　IP地址分为A B C D E类<br>
　　优点是简单明了，选路简单<br>
　　缺点是同一网络地址下没有地址层次，缺少地址灵活性；不能很好与现实网络匹配<br>

step 3：<br>
　　基于上述缺点，提出了CIDR(无分类地址)<br>
　　利用子网掩码进行地址划分：网络地址+子网网络地址+子网主机地址<br>

step 4：<br>
　　利用IP的网络地址进行路由控制和转发<br>

step 5：<br>
　　TCP分片MSS，加报头称为MTU<br>

step 6：<br>
　　简单介绍了下IPV6地址<br>

接着介绍了和IP相关的几个协议：<br>

- DNS：用于将域名解析为IP地址
- ARP：数据传输时，可以通过路由表知道下一跳ip地址(网络层)，但还需要通过ARP知道下一跳的MAC地址(数据链路层)
  - ARP请求和响应
  - 广播
  - 缓存
- RARP：ARP是已知IP求MAC，RARP则是已知MAC求IP
- DHCP：动态主机设定协议，用于设置主机IP地址
  - 四个步骤
  - 使用的是广播，所以需要DHCP中继代理
- NAT：缓解IPv4地址耗尽的速度
  - 由于NAT的一对一缺点，提出了NAPT(网络地址与端口转换)，使用IP地址和端口号一起进行转换
  - 缺点就是太依赖转换表
- ICMP：遇到问题的时候报告遇到了什么问题，以方便采取策略解决
  - 主要的功能包括：确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等
- IGMP：因特网组管理协议，用于组播管理组


# ping 的工作原理

ping是基于ICMP协议工作的，所以首先要了解ICMP协议的原理。<br>

ICMP协议的全称是互联网控制报文协议，提出此协议的原因是在复杂的互联网环境中传输信息时可能会出错，这个时候就要报错以调整传输策略。<br>

所以它的功能如下：

1. 确定IP包是否成功到达目标地址
2. 报告发送过程中IP包被废弃的原因和改善网络设置等

对应以上两个功能，ICMP有两种报文：

1. 查询报文类型
2. 差错报文类型

查询报文是用于判断发送的数据包是否已经成功到达对端的一种消息，可以分为两类，分别是回送请求消息和回送应答消息。<br>
其中回送请求消息是发送端主机向接收端主机发送的消息，类型为8；回送应答消息是接收端主机向发送端主机发回来的消息，类型为0。<br>

差错报文类型我了解的有三种，分别是目标不可达消息、重定向消息和超时消息。

1. 目标不可达具体原因可以详细分为以下几类：

   - 网络不可达：原因是路由器当中的路由表匹配不到接收方IP的网络号，就通过ICMP协议以网络不可达的原因告知主机，代码为0。
   - 主机不可达：路由器中的路由表中没有主机的消息或者主机没有连接到网络，会通过ICMP协议以主机不可达的原因告知主机，代码为1。
   - 协议不可达：当主机使用TCP协议访问对端主机，可以找到对端主机，但是对端主机的防火墙已经禁止TCP协议的访问，会通过ICMP协议以协议不可达的原因告知主机，代码为2。
   - 端口不可达：发送端主机可以找到对端主机，也没有防火墙限制，可以对端主机没有监听要访问的接口，会通过ICMP协议以端口不可达的原因告知主机，代码为3。
   - 需要分片但设置了不分片：发送端主机发送IP数据报时，数据报的大小超过了途中路由器允许的MTU大小，且IP首部的分片禁止标志位设置为1，这个时候路由器会直接抛弃该数据报，并通过ICMP协议以需要分片但设置了不分片的原因告知主机，代码为4。

2. 重定向消息

   - 在路由器持有更好的路由信息的情况下，它发现发送端主机使用了不是最优的路劲发送数据，就会返回一个ICMP重定向消息告知主机，这个消息中包含了最合适的路由信息。

3. 超时消息

   - 首先要知道 IP 包中有一个字段叫做 TTL （Time To Live，生存周期），它的值随着每经过一次路由器就会减 1，直到减到 0 时该 IP 包会被丢弃。此时，路由器将会发送一个 ICMP 超时消息给发送端主机，并通知该包已被丢弃。
   - 设置 IP 包生存周期的主要目的，是为了在路由控制遇到问题发生循环状况时，避免 IP 包无休止地在网络上被转发。


了解了以上ICMP协议的基础知识后，我们来进一步了解ping的工作原理。<br>
首先设定最简单的场景：同一个子网下的主机A和主机B，主机A执行ping主机B。<br>
接着可以参考小林coding图解理解，以下仅做关键字记录：<br>

主机A过程：

1. ICMP回送请求报文：类型、序号、发送时间
2. 加上IP头形成IP数据报：源地址、目标地址、协议
3. 加上MAC头形成数据帧：目标地址对应的目标MAC、本机MAC地址

主机B过程：

1. 收到A发过来的数据帧后，检查MAC地址是否匹配已确定是否接收，若接收则把IP数据包提取出来交给IP层
2. 接着按照同样的步骤，检查、提取ICMP回送请求报文给ICMP协议
3. ICMP协议根据ICMP回送请求报文生成一个ICMP回送响应报文：字段、序号、发送时间

在规定的时间，若主机A收到主机B发回来的ICMP回送响应报文，说明目标主机可达，否则不可达。


# 断网了还能ping通127.0.0.1吗

**127.0.0.1 和 localhost 以及 0.0.0.0 有什么区别？**<br>

localhost 是域名，默认解析为 127.0.0.1，ping 0.0.0.0 是会失败的，因为它在 IPV4 中表示无效的目标地址。如果listen的是 0.0.0.0，则它表示本机上的所有 IPV4 地址。<br>

**ping 回环地址和本机地址没有区别**<br>

ping 回环地址和本机地址是一样的，走的都是 lo0 假网卡，都会经过网络层和数据链路层，之后会将数据插入到一个链表后，就软中断通知内核来进行收数据，根本不会走出网络，所以断网了也可以 ping 通回环地址。<br>

**TCP 和 ping 发数据的区别**<br>

1. 所在的层次不一样：通过 TCP 发送数据工作的层是在传输层，通过 ping 发送数据工作的层是在网络层。
2. 数据的结构不一样：前者包含 TCP 头，后者包含 ICMP 头。
3. 套接字不一样：前者是 sock_stream ，指的是使用面向字节流的 TCP 协议，后者使用的是 sock_raw 原始套接字。

